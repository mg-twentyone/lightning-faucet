<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sats Faucet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center">
    <div id="app" class="max-w-md w-full bg-gray-800 p-8 rounded-xl shadow-2xl border border-gray-700 text-center">
        
        <h1 class="text-3xl font-bold mb-2 text-yellow-500">âš¡ Lightning Faucet</h1>
        <p class="text-gray-400 mb-6">Claim Sats instantly</p>

        <div v-if="mounted">
            <div class="flex justify-between items-center mb-6 p-3 bg-gray-900/50 rounded-lg border border-gray-700">
                <div class="text-left">
                    <span class="text-[10px] uppercase tracking-widest text-gray-500 block">Available Balance</span>
                    <div class="text-lg font-mono text-green-400 leading-none">
                        {{ balance.toLocaleString() }} <span class="text-xs text-gray-500">sats</span>
                    </div>
                </div>
                <div class="text-right">
                    <span class="text-[10px] uppercase tracking-widest text-gray-500 block">Status</span>
                    <div v-if="balance >= maxAmount" class="flex items-center text-xs text-green-500 font-bold">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse mr-1"></span> ONLINE
                    </div>
                    <div v-else class="flex items-center text-xs text-red-500 font-bold">
                        <span class="w-2 h-2 bg-red-500 rounded-full mr-1"></span> LOW FUNDS
                    </div>
                </div>
            </div>

            <div v-if="!lnurl">
                <!-- <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-400 mb-2">
                        Amount: <span class="text-yellow-500 font-bold">{{ selectedAmount }}</span> Sats
                    </label>
                    <input type="range" v-model="selectedAmount" min="1" :max="maxAmount" 
                        class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-yellow-500">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>1 Sat</span>
                        <span>{{ maxAmount }} Sats</span>
                    </div>
                </div> -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-400 mb-2 text-left">
                        Paste Lightning Invoice (Bolt11)
                    </label>
                    <textarea 
                        v-model="invoice" 
                        placeholder="lnbc..." 
                        rows="3"
                        class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-sm font-mono text-yellow-500 focus:border-yellow-500 focus:outline-none resize-none"
                    ></textarea>
                </div>

                <div ref="turnstileBox" class="flex justify-center mb-4"></div>
                
                <button v-if="token" @click="claim" :disabled="loading || !invoice"
                    class="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-3 rounded-lg transition disabled:opacity-50">
                    {{ loading ? 'Generating...' : 'Claim ' + selectedAmount + ' Sats' }}
                </button>
                <p v-if="error" class="mt-4 text-red-400 text-sm bg-red-900/20 p-2 rounded border border-red-900/50">{{ error }}</p>
            </div>

            <div v-else class="space-y-4 animate-in fade-in zoom-in duration-300">
                <div class="bg-white p-4 rounded-lg inline-block">
                    <canvas id="qr-code"></canvas>
                </div>
                <p class="text-sm text-gray-400 break-all font-mono bg-black/30 p-3 rounded">
                    {{ lnurl }}
                </p>
                <button @click="reset" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 rounded-lg transition">
                    Done / Claim Again
                </button>
            </div>
        </div>
        <div v-else class="text-gray-600 animate-pulse">Initializing Faucet...</div>
    </div>

    <script>
    const { createApp, ref, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            const mounted = ref(false);
            const turnstileBox = ref(null);
            const token = ref(null);
            const lnurl = ref(null);
            const loading = ref(false);
            const error = ref(null);
            const balance = ref(0);
            const invoice = ref("");
            
            // GO TEMPLATE VARIABLES (Note the . prefix)
            const maxAmount = parseInt("[[ .max_amount ]]") || 100;
            const SITE_KEY = "[[ .site_key ]]";
            const selectedAmount = ref(Math.floor(maxAmount / 2));

            const renderTurnstile = () => {
                if (window.turnstile && turnstileBox.value) {
                    window.turnstile.render(turnstileBox.value, {
                        sitekey: SITE_KEY,
                        callback: (t) => { token.value = t; },
                    });
                }
            };

            onMounted(async () => {
                mounted.value = true;
                await nextTick();
                
                try {
                    const res = await fetch('/api/info');
                    const data = await res.json();
                    balance.value = data.balance;
                } catch (e) { console.error("Balance check failed"); }

                if (window.turnstile) {
                    renderTurnstile();
                }
            });

            const claim = async () => {
                loading.value = true;
                error.value = null;
                try {
                    const res = await fetch('/api/claim', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            captcha_token: token.value,
                            invoice: invoice.value
                            // amount: parseInt(selectedAmount.value)
                        })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.detail || 'Server error');

                    paymentHash.value = data.payment_hash;
                    
                    // lnurl.value = data.lnurl;
                    // await nextTick();
                    // // Generate QR code on the canvas
                    // QRCode.toCanvas(document.getElementById('qr-code'), data.lnurl, { 
                    //     width: 200,
                    //     margin: 1,
                    //     color: { dark: '#000000', light: '#ffffff' }
                    // });
                } catch (e) {
                    error.value = e.message;
                    token.value = null;
                    if(window.turnstile) window.turnstile.reset();
                } finally {
                    loading.value = false;
                }
            };

            const reset = () => window.location.reload();

            return { 
                mounted, turnstileBox, token, lnurl, invoice,loading,
                error, maxAmount, selectedAmount, balance, claim, reset
            };
        }
    }).mount('#app');
    </script>
</body>
</html>